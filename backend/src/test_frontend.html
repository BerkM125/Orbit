<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Test Join Room</title>
	<style>
		body { font-family: Arial, Helvetica, sans-serif; padding: 2rem; }
		button { font-size: 1rem; padding: 0.5rem 1rem; }
		.form-row { margin: 1rem 0; }
		label { display: inline-block; margin-right: 1rem; }
		input[type="number"] { width: 120px; }
		pre { background: #f6f6f6; padding: 1rem; border-radius: 4px; margin-top: 0.5rem; }
	</style>
</head>
<body>
	<h1>Socket.IO â€” Join Room Tester</h1>
	<p>Click the button below to connect to the Socket.IO server and request to join the <strong>cascadia</strong> room.</p>
	<button id="joinBtn">Join "cascadia" Room</button>

	<section class="form-row">
		<h3>Update Location (Local Only)</h3>
		<p>This form updates your location data locally (does not send to server)</p>
		<div class="form-row">
			<label>Latitude: <input type="number" id="latInput" step="any" /></label>
			<label>Longitude: <input type="number" id="lngInput" step="any" /></label>
			<button id="updateLocationBtn">Update Location</button>
		</div>
		<div id="locationStatus"></div>
		<div class="form-row">
			<h4>Current userData:</h4>
			<pre id="userDataDisplay"></pre>
		</div>
	</section>

	<!-- Socket.IO client from CDN -->
	<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
	<script>
        // Connect to the socket server
		const socket = io('https://6f3ad484c5c1.ngrok-free.app');

        // This is an example of the client's "full" database. NOT sent to the server, only received.
        let localRoomData = {
            id: 'cascadia',
            name: 'Cascadia Hackathon',
            users: []
        };

        // And this is the client's OWN data, that it will SEND to the server.
        let userData = {
            name: "Berkan Mertan",
            // No userId - will be assigned by Supabase
            linkedin_url: "https://www.linkedin.com/in/berkan-m/",
            bio: "SDE Intern @ UW",
            headshot_image: "https://media.licdn.com/dms/image/D4D03AQHjv1eXHk1m7g/profile-displayphoto-shrink_800_800/0/1678887038471?e=1701302400&v=beta&t=ZKJ3nY3c1kC8qfO2nF9lJd8nG4p6Ykz8b9rY3F4g6Uo",
            location: {
                latitude: 47.6062,
                longitude: -122.3321
            }
        };
        
        // First, join the room with the sample user data
        socket.emit("join-room", userData);

        // This is how to listen for server requests for location
        socket.on("get-location", () => {
            socket.emit("send-location", userData);
        });

        // And this is how to listen for server sending location data
        socket.on("update-data", (data) => {
            localRoomData = data;
            alert(JSON.stringify(localRoomData));
        });

        // Listen for user data updates (including UUID assignment)
        socket.on("user-data-updated", (updatedData) => {
            userData = { ...userData, ...updatedData };
            updateUserDataDisplay();
            console.log("Received updated user data with UUID:", userData);
        });

        // Handle any join errors
        socket.on("join-error", (error) => {
            console.error("Failed to join room:", error.message);
        });

        // Local-only form handling (no socket emissions)
        function updateUserDataDisplay() {
            document.getElementById('userDataDisplay').textContent = JSON.stringify(userData, null, 2);
            document.getElementById('latInput').value = userData.location.latitude;
            document.getElementById('lngInput').value = userData.location.longitude;
        }

        document.getElementById('updateLocationBtn').addEventListener('click', () => {
            const lat = parseFloat(document.getElementById('latInput').value);
            const lng = parseFloat(document.getElementById('lngInput').value);
            
            if (Number.isFinite(lat) && Number.isFinite(lng)) {
                userData.location = { latitude: lat, longitude: lng };
                updateUserDataDisplay();
                const status = document.getElementById('locationStatus');
                status.textContent = 'Location updated locally (not sent to server)';
                status.style.color = 'green';
            } else {
                const status = document.getElementById('locationStatus');
                status.textContent = 'Please enter valid numbers for latitude and longitude';
                status.style.color = 'red';
            }
        });

        // Initial display
        updateUserDataDisplay();
	</script>
</body>
</html>
